parameters:
  - name: "licenseplate" # defaults for any parameters that aren't specified
    type: string
    default: 0bd5ad
    values:
      - c8055e  #Gold Cluster Namespace
      - 0bd5ad  #Silver Cluster Namespace
      - azure   #Azure

  - name: publish
    type: boolean
    default: true

steps:
  - task: Cache@2
    displayName: 'Fetch NPM Cache'
    condition: eq(variables['NPMInstall'], true)
    inputs:
      key: 'npm | "$(Agent.OS)" | $(App.Home)/src/ClientApp/package-lock.json'
      path: '$(App.Home)/src/ClientApp/node_modules'
      cacheHitVar: 'CACHE_RESTORED'
      restoreKeys: 'npm | "$(Agent.OS)"'

  - task: Npm@1
    displayName: "Installing NPM Packages"
    condition: and(succeeded(), and(ne(variables.CACHE_RESTORED, 'true'), eq(variables['NPMInstall'], true)))
    inputs:
      command: "install"
      workingDir: "$(App.Home)/src/ClientApp"

  - task: Npm@1
    displayName: "Running NPM Tests for $(App.Name)"
    condition: and(succeeded(), eq(variables['NPMTests'], true))
    inputs:
      command: "custom"
      customCommand: "test"
      workingDir: "$(App.Home)/src/ClientApp"

  - task: DotNetCoreCLI@2
    displayName: "Compiling code for $(App.Name)"
    condition: and(succeeded(), eq(variables['WASMBuild'], false))
    inputs:
      projects: "$(App.Home)/src"
      arguments: "--no-incremental /warnaserror"

  - task: DotNetCoreCLI@2
    displayName: "Compiling code for Blazor Solution $(App.Name)"
    condition: and(succeeded(), eq(variables['WASMBuild'], true))
    inputs:
      projects: "$(App.Home)"
      arguments: "--no-incremental /warnaserror"

  - task: DotNetCoreCLI@2
    displayName: "Runing Unit Tests for $(App.Name)"
    condition: and(succeeded(), and(eq(variables['WASMBuild'], false),eq(variables['UnitTests'], true)))
    inputs:
      command: "test"
      projects: "$(App.Home)/test/unit/$(App.Name)Tests.csproj"
      arguments: "/p:CollectCoverage=true /p:CoverletOutputFormat=cobertura"
      testRunTitle: "$(App.Name): Performing Unit Tests"

  - task: DotNetCoreCLI@2
    displayName: "Runing Unit Tests for Blazor Solution $(App.Name)"
    condition: and(succeeded(), and(eq(variables['WASMBuild'], true),eq(variables['UnitTests'], true)))
    inputs:
      command: "test"
      projects: "$(App.Home)"
      arguments: "/p:CollectCoverage=true /p:CoverletOutputFormat=cobertura"
      testRunTitle: "$(App.Name): Performing Unit Tests"

  - script: |
      set -e
      if [ "$(EnableAzure)" = True ] ; then
          echo Running in Azure, Installing dotnet-reportgenerator
          dotnet tool install -g dotnet-reportgenerator-globaltool
      else
          echo Running in OpenShift, skipping dotnet-reportgenerator tool install
      fi
      reportgenerator -reports:$(App.Home)/test/**/coverage.cobertura.xml -targetdir:$(App.Home)/CodeCoverage -reporttypes:"HtmlInline_AzurePipelines;Cobertura"
    displayName: "Creating Code Coverage Report for $(App.Name)"
    condition: and(succeeded(), and(eq(variables['WASMBuild'], false),eq(variables['UnitTests'], true)))

  - script: |
      set -e
      if [ "$(EnableAzure)" = True ] ; then
          echo Running in Azure, Installing dotnet-reportgenerator
          dotnet tool install -g dotnet-reportgenerator-globaltool
      else
          echo Running in OpenShift, skipping dotnet-reportgenerator tool install
      fi
      reportgenerator -reports:$(App.Home)/coverage.cobertura.xml -targetdir:$(App.Home)/CodeCoverage -reporttypes:"HtmlInline_AzurePipelines;Cobertura"
    displayName: "Creating Code Coverage Report for Blazor Solution $(App.Name)"
    condition: and(succeeded(), and(eq(variables['WASMBuild'], true),eq(variables['UnitTests'], true)))

  - task: PublishCodeCoverageResults@1
    displayName: "Publishing Code Coverage for $(App.Name)"
    condition: and(succeeded(), and(eq(${{ parameters.publish }}, true), eq(variables['UnitTests'], true)))
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: "$(App.Home)/CodeCoverage/Cobertura.xml"
      pathToSources: "$(App.Home)/src"
      reportDirectory: "$(App.Home)/CodeCoverage"

  - task: DotNetCoreCLI@2
    displayName: "Publishing code for $(App.Name)"
    condition: and(succeeded(), eq(variables['WASMBuild'], false))
    inputs:
      modifyOutputPath: false
      command: "publish"
      publishWebProjects: false
      projects: "$(App.Home)/src"
      arguments: "-o $(Build.BinariesDirectory)"
      zipAfterPublish: false

  - task: DotNetCoreCLI@2
    displayName: "Publishing code for Blazor Solution $(App.Name)"
    condition: and(succeeded(), eq(variables['WASMBuild'], true))
    inputs:
      modifyOutputPath: false
      command: "publish"
      publishWebProjects: false
      projects: "$(App.Home)/Server"
      arguments: "-o $(Build.BinariesDirectory)"
      zipAfterPublish: false

  - task: Docker@2
    displayName: 'Building Image for $(App.Name) and pushing to Docker Hub'
    inputs:
      containerRegistry: 'docker-health'
      repository: $(DockerRepo)/$(Image.Name)
      Dockerfile: '$(App.Home)/Dockerfile'
      buildContext: '$(Build.BinariesDirectory)'
      tags: '$(Build.BuildNumber)'
    condition: and(succeeded(), and(eq(variables['CreateImage'], true),ne(variables['EnableOpenShift'], true)))

  - script: |
      set -e
      if [ "$(EnableAzure)" = True ] ; then
          echo Running in Azure, authenticating with OpenShift
          oc login --token=$(OpenShiftToken) --server=$(OpenShiftUri)
      else
          echo Running in OpenShift, skipping auth
      fi
      oc projects
      oc project ${{ parameters.licenseplate }}-tools
      cp $(App.Home)/Dockerfile $(Build.BinariesDirectory)
      oc process -f $(Build.SourcesDirectory)/Tools/BaseBuild/build.yaml -p NAME=$(Image.Name) | oc apply -f -
      oc start-build $(Image.Name) --wait --follow --from-dir $(Build.BinariesDirectory) 
      oc tag $(Image.Name):latest $(Image.Name):$(Build.BuildNumber)
    displayName: "Building Image for $(App.Name) and pushing to OpenShift Image Stream"
    condition: and(succeeded(), and(eq(variables['CreateImage'], true),eq(variables['EnableOpenShift'], true)))
