parameters:
  - name: Application
    type: string
    default: NotSpecified
    values:
      - Admin
      - AdminWebClient
      - Common
      - Database
      - Encounter
      - Immunization
      - JobScheduler
      - Laboratory
      - Medication
      - Patient
      - WebClient
      - Mock
      - CommonUi
      - CommonData
      - NotSpecified

  - name: ImageName
    type: string
    default: ""

  - name: DotNetTests
    type: boolean
    default: true

  - name: NPMInstall
    type: boolean
    default: false

  - name: NPMTests
    type: boolean
    default: false

  - name: Library
    type: boolean
    default: false

  - name: EnableOpenShift
    type: boolean
    default: true

  - name: EnableAzure
    type: boolean
    default: false
    
  - name: WASMBuild
    type: boolean
    default: false

#Build variables
variables:
  App.Name: ${{ parameters.Application }}
  WASMBuild: ${{ parameters.WASMBuild }}
  NPMInstall: ${{ parameters.NPMInstall }}
  NPMTests: ${{ parameters.NPMTests }}
  UnitTests: ${{ parameters.DotNetTests }}
  Library: ${{ parameters.Library }}
  EnableOpenShift: ${{ parameters.EnableOpenShift }}
  EnableAzure: ${{ parameters.EnableAzure }}
  App.Home: $(Build.SourcesDirectory)/Apps/$(App.Name)
  ${{ if parameters.ImageName }}:
    Image.Name: $[lower('${{ parameters.ImageName }}')]
  ${{ if not(parameters.ImageName) }}:
    Image.Name: $[lower(variables['App.Name'])]
  App.UnitTests: $(App.Home)/test/unit
  PullRequest: $[eq(variables['Build.Reason'], 'PullRequest')]
  CreateImage: $[and(eq(variables['Library'],false), eq(variables['PullRequest'],false))]
  ${{ if eq(variables['PullRequest'], true) }}:
    BuildPrefix: "PR-$(SourceBranchName)"
  ${{ if eq(variables['PullRequest'], false) }}:
    BuildPrefix: "$(SourceBranchName)"

jobs:
  - job: "Azure"
    pool:
      vmImage: "ubuntu-20.04"
    displayName: "Build ${{ parameters.Application }} in Azure Cloud"
    condition: eq(variables['EnableAzure'], true)
    steps:
      - template: /Build/hg-steps-template.yaml
        parameters:
          toolsNamespace: "azure"

  - job: "OpenShift"
    pool:
      name: "HealthGateway"
    displayName: "Build ${{ parameters.Application }} in Openshift"
    condition: eq(variables['EnableOpenShift'], true)
    steps:
      - template: /Build/hg-steps-template.yaml
        parameters:
          toolsNamespace: "0bd5ad"
          publish: false
