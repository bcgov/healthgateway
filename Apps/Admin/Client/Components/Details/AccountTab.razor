@using HealthGateway.Admin.Client.Components.Support
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@if (Patient != null)
{
    <MudText Class="mb-4 mt-6" Typo="Typo.h6">
        Account Details
    </MudText>
    <MudGrid Spacing="4">
        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Reviewer}")">
            @if (!string.IsNullOrWhiteSpace(Patient.Hdid))
            {
                <MudItem xs="12">
                    <HgField Label="HDID" Value="@Patient.Hdid" data-testid="patient-hdid"/>
                </MudItem>
            }
        </AuthorizeView>

        @if (IsDefaultPatientStatus)
        {
            <MudItem xs="12" lg="6">
                <HgField Label="Account Created" Value="@ProfileCreatedDateTime.ToString()"
                         data-testid="profile-created-datetime"/>
            </MudItem>
            <MudItem xs="12" lg="6">
                <HgField Label="Last Login" Value="@ProfileLastLoginDateTime.ToString()"
                         data-testid="profile-last-login-datetime"/>
            </MudItem>
            @if (ShowApiRegistration && PatientSupportDetailsLoading)
            {
                <MudItem xs="12">
                    <MudProgressLinear Class="rounding-t overflow-hidden"
                                       Color="Color.Primary"
                                       Indeterminate="true"/>
                </MudItem>
            }

            @if (ShowApiRegistration)
            {
                <MudItem xs="12">
                    <HgField Label="Api Registration" Value="@IsAccountRegistered?.ToString()"
                             data-testid="api-registration"/>
                </MudItem>
            }

            @if (ShowImagingRefresh)
            {
                <MudItem xs="12">
                    <MudText Class="mb-0 mt-0" Typo="Typo.h6">
                        Imaging Reports (Provincial Digital Imaging Vault)
                    </MudText>
                </MudItem>
                <MudItem xs="12">
                    <HgField Class="mb-0"
                             Label="Last Refreshed Date"
                             Value="@LastImagingRefreshDate?.ToString()"
                             InlineContent="ImagingCacheRefreshButton"
                             data-testid="last-imaging-refresh-date"/>
                </MudItem>
            }

            @if (ShowLabsRefresh)
            {
                <MudItem xs="12">
                    <MudText Class="mb-0 mt-0" Typo="Typo.h6">
                        Labs Cache (Provincial Laboratory Information Solution)
                    </MudText>
                </MudItem>
                <MudItem xs="12">
                    <HgField Class="mb-0"
                             Label="Last Refreshed Date"
                             Value="@LastLabsRefreshDate?.ToString()"
                             InlineContent="LabsCacheRefreshButton"
                             data-testid="last-labs-refresh-date"/>
                </MudItem>
            }
        }
        else
        {
            <MudItem xs="12">
                <MudText data-testid="no-hg-profile">
                    No Health Gateway Profile
                </MudText>
            </MudItem>
        }
    </MudGrid>
}

<AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Reviewer}")">
    @if (IsDefaultPatientStatus)
    {
        <MessageVerificationTable Data="@MessagingVerifications" IsLoading="@PatientSupportDetailsLoading"/>
    }
</AuthorizeView>

@code {

    private RenderFragment ImagingCacheRefreshButton => @<HgButton
                                                            EndIcon="fas fa-arrow-rotate-right"
                                                            Variant="@Variant.Filled"
                                                            Color="@Color.Primary"
                                                            Loading="@RefreshImagingCacheIsLoading"
                                                            Disabled="@(RefreshImagingCacheIsLoading || PatientSupportDetailsLoading)"
                                                            OnClick="@RefreshImagingCache"
                                                            data-testid="imaging-cache-refresh-button">
                                                            Refresh
                                                        </HgButton>;

    private RenderFragment LabsCacheRefreshButton => @<HgButton
                                                         EndIcon="fas fa-arrow-rotate-right"
                                                         Variant="@Variant.Filled"
                                                         Color="@Color.Primary"
                                                         Loading="@RefreshLabCacheIsLoading"
                                                         Disabled="@(RefreshLabCacheIsLoading || PatientSupportDetailsLoading)"
                                                         OnClick="@RefreshLabsCache"
                                                         data-testid="labs-cache-refresh-button">
                                                         Refresh
                                                     </HgButton>;

}
