@using HealthGateway.Admin.Client.Components.Support
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

@if (Patient != null)
{
    <MudText Class="mb-4 mt-6" Typo="Typo.h6">
        Account Details
    </MudText>
    <MudGrid Spacing="4">
        <AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Reviewer}")">
            @if (!string.IsNullOrWhiteSpace(Patient.Hdid))
            {
                <MudItem xs="12">
                    <HgField Label="HDID" Value="@Patient.Hdid" data-testid="patient-hdid"/>
                </MudItem>
            }
        </AuthorizeView>

        @if (IsDefaultPatientStatus)
        {
            <MudItem xs="12" lg="6">
                <HgField Label="Account Created" Value="@ProfileCreatedDateTime.ToString()"
                         data-testid="profile-created-datetime"/>
            </MudItem>
            <MudItem xs="12" lg="6">
                <HgField Label="Last Login" Value="@ProfileLastLoginDateTime.ToString()"
                         data-testid="profile-last-login-datetime"/>
            </MudItem>
            @if (PatientSupportDetailsLoading)
            {
                <MudItem xs="12">
                    <MudProgressLinear Class="rounding-t overflow-hidden"
                                       Color="Color.Primary"
                                       Indeterminate="true"/>
                </MudItem>
            }

            <MudItem xs="12">
                <HgField Label="Api Registration" Value="@IsAccountRegistered?.ToString()"
                         data-testid="api-registration"/>
            </MudItem>
            <MudItem xs="12">
                <MudText Class="mb-4 mt-6" Typo="Typo.h6">
                    Imagining Reports (Provincial Digital Imaging Vault)
                </MudText>
            </MudItem>
            <MudItem xs="12">
                <HgField Label="Last Refreshed Date"
                         Value="@LastDiagnosticImagingRefreshDate?.ToString()"
                         InlineContent="DiagnosticImagingRefreshButton"
                         data-testid="last-diagnostic-image-refresh-date"/>
            </MudItem>
            <MudItem xs="12">
                <MudText Class="mb-4 mt-6" Typo="Typo.h6">
                    Labs Cache (Provincial Laboratory Information Solution)
                </MudText>
            </MudItem>
            <MudItem xs="12">
                <HgField Label="Last Refreshed Date"
                         Value="@LastLaboratoryRefreshDate?.ToString()"
                         InlineContent="LaboratoryRefreshButton"
                         data-testid="last-laboratory-refresh-date"/>
            </MudItem>
        }
        else
        {
            <MudItem xs="12">
                <MudText data-testid="no-hg-profile">
                    No Health Gateway Profile
                </MudText>
            </MudItem>
        }
    </MudGrid>
}

<AuthorizeView Roles="@($"{Roles.Admin}, {Roles.Reviewer}")">
    @if (IsDefaultPatientStatus)
    {
        <MessageVerificationTable Data="@MessagingVerifications" IsLoading="@PatientSupportDetailsLoading"/>
    }
</AuthorizeView>

@code {

    private RenderFragment DiagnosticImagingRefreshButton => @<HgButton
                                                                 EndIcon="fas fa-arrow-rotate-right"
                                                                 Variant="@Variant.Filled"
                                                                 Color="@Color.Primary"
                                                                 Loading="@RefreshDiagnosticImagingCacheIsLoading"
                                                                 Disabled="@(RefreshDiagnosticImagingCacheIsLoading || PatientSupportDetailsLoading)"
                                                                 OnClick="@RefreshDiagnosticImagingCache"
                                                                 data-testid="diagnostic-imaging-refresh-button">
                                                                 Refresh
                                                             </HgButton>;

    private RenderFragment LaboratoryRefreshButton => @<HgButton
                                                          EndIcon="fas fa-arrow-rotate-right"
                                                          Variant="@Variant.Filled"
                                                          Color="@Color.Primary"
                                                          Loading="@RefreshLaboratoryCacheIsLoading"
                                                          Disabled="@(RefreshLaboratoryCacheIsLoading || PatientSupportDetailsLoading)"
                                                          OnClick="@RefreshLaboratoryCache"
                                                          data-testid="laboratory-refresh-button">
                                                          Refresh
                                                      </HgButton>;

}
